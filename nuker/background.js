// React when the browser action's icon is clicked.
chrome.browserAction.onClicked.addListener(function(tab) {
  // Add the script code to the header
  chrome.tabs.executeScript({
    code: 'var script = document.createElement("script"); script.id = "nukerjs";'
          + 'script.innerHTML = "function startMetafieldNuker(){startTime=Date.now(),targetNamespace=$(\\"#namespace\\").val(),loggingEnabled=$(\\"#logging\\").val(),getProductCount()}function getProductCount(){productCount=0,variantCount=0,$.ajax({url:location.origin+\\"\/admin\/products\/count.json\\",success:function(e){productCount=e.count,console.log(\\"Found \\"+productCount+\\" products on \\"+location.origin);var t=1;productCount>250&&(t=Math.ceil(productCount\/250));var n=[];getProductsByPage(n,t,1)},error:function(e){throw\\"Oops! Something happened getting the product count... Error: \\"+e.status+\\" (\\"+e.statusText+\\")\\"}})}function getProductsByPage(e,t,n){t>=n?(console.log(t>1?\\"Grabbing products in blocks of 250 at a time - Page \\"+n+\\"...\\":\\"Grabbing products...\\"),$.ajax({url:location.origin+\\"\/admin\/products.json?fields=id,variants&limit=250&page=\\"+n,dataType:\\"json\\",success:function(a){for(var o=0;o<a.products.length;o++){for(var i=[],r=0;r<a.products[o].variants.length;r++)i.push({id:a.products[o].variants[r].id}),variantCount++;e.push({id:a.products[o].id,variants:i})}n++,getProductsByPage(e,t,n)},error:function(e){throw\\"Oops! Something happened getting the products on page \\"+n+\\"... Error: \\"+e.status+\\" (\\"+e.statusText+\\")\\"}})):checkProducts(e,0,null,0)}function checkProducts(e,t,n,a){t<e.length?(null==n&&(n=e[t].variants),a<n.length?(console.log(\\"    Checking variant ID: \\"+n[a].id+\\" for metafields in namespace: \\"+targetNamespace+\\" - (\\"+(a+1)+\\"\/\\"+n.length+\\")\\"),$.ajax({url:location.origin+\\"\/admin\/variants\/\\"+n[a].id+\\"\/metafields.json?fields=id,namespace\\",dataType:\\"json\\",success:function(o){for(var i=0;i<o.metafields.length;i++)o.metafields[i].namespace==targetNamespace&&deleteMetafield(\\"variant\\",n[a].id,o.metafields[i].id);a++,checkProducts(e,t,n,a)},error:function(n){throw\\"Oops! Something happened getting the metafields for variant ID: \\"+e[t].variants[o].id+\\". Error: \\"+n.status+\\" (\\"+n.statusText+\\")\\"}})):(console.log(\\"    Checking product ID: \\"+e[t].id+\\" for metafields in namespace: \\"+targetNamespace),$.ajax({url:location.origin+\\"\/admin\/products\/\\"+e[t].id+\\"\/metafields.json?fields=id,namespace\\",dataType:\\"json\\",success:function(n){for(var a=0;a<n.metafields.length;a++)n.metafields[a].namespace==targetNamespace&&deleteMetafield(\\"product\\",e[t].id,n.metafields[a].id);t++,checkProducts(e,t,null,0)},error:function(n){throw\\"Oops! Something happened getting the metafields for product ID: \\"+e[t].id+\\". Error: \\"+n.status+\\" (\\"+n.statusText+\\")\\"}}))):(console.log(\\"  Finished nuking current product...\\"),houseKeeping())}function deleteMetafield(e,t,n){$.ajax({method:\\"DELETE\\",url:location.origin+\\"\/admin\/\\"+e+\\"\/\\"+t+\\"\/metafields\/\\"+n+\\".json\\",success:function(){console.log(\\"      Nuked metafield ID \\"+n+\' in namespace \\"\'+targetNamespace+\'\\" for \'+e+\\" ID: \\"+t)},error:function(e){throw\\"Oops! Something happened deleting the metafield... Error: \\"+e.status+\\" (\\"+e.statusText+\\")\\"}})}function houseKeeping(){finishTime=Date.now();var e=(finishTime-startTime)\/1e3;console.log(\\"Finished checking \\"+variantCount+\\" variants.\\"),console.log(\\"Job took \\"+e.toString().toElapsedTime()+\\" to complete.\\")}$(\\"html\\").addClass(\\"nukerJSoverride\\"),$(\\"body\\").append(\'<div id=\\"nukerJSbar\\" class=\\"fadein\\"><\/div>\'),$(\\"#nukerJSbar\\").append(\'<div class=\\"wrapper clearfix\\"><\/div>\'),$(\\"#nukerJSbar .wrapper\\").append(\'<ul id=\\"nukerJSnav\\"><\/ul>\'),$(\\"#nukerJSnav\\").append(\'<li><a id=\\"bn_about\\">About Nuker<\/a><\/li>\'),$(\\"#nukerJSnav\\").append(\'<li class=\\"hidden\\"><\/li>\'),$(\\"#nukerJSnav\\").append(\'<li><select id=\\"ns-selector\\"><\/select><\/li>\'),$(\\"#ns-selector\\").append(\'<option value=\\"bold_measurement\\">Buy the Measurement<\/option>\'),$(\\"#ns-selector\\").append(\'<option value=\\"shappify_csp\\">Customer Pricing<\/option>\'),$(\\"#ns-selector\\").append(\'<option value=\\"shappify_bundle\\">Product Bundles<\/option>\'),$(\\"#ns-selector\\").append(\'<option value=\\"shappify_qb\\">Quantity Breaks<\/option>\'),$(\\"#nukerJSnav\\").append(\'<li><a id=\\"bn_nuke\\">Nuke Metafields<\/a><\/li>\'),$(\\"#nukerJSnav\\").append(\'<li><a id=\\"bn_settings\\">Settings<\/a><\/li>\'),$(\\"#nukerJSnav\\").append(\\"<li><\/li>\\"),$(\\"#nukerJSbar .wrapper\\").append(\'<input type=\\"hidden\\" id=\\"namespace\\" value=\\"bold_measurement\\">\'),$(\\"#nukerJSbar .wrapper\\").append(\'<input type=\\"hidden\\" id=\\"logging\\" value=\\"true\\">\'),$(\\"#ns-selector\\").on(\\"change\\",function(){$(\\"#namespace\\").val($(\\"#ns-selector option:selected\\").val())}),$(\\"#bn_nuke\\").on(\\"click\\",function(){startMetafieldNuker()}),String.prototype.toElapsedTime=function(){var e=parseInt(this,10),t=Math.floor(e\/3600),n=Math.floor((e-3600*t)\/60),a=e-3600*t-60*n,o=t+\\" hours, \\"+n+\\" minutes, \\"+a+\\" seconds\\";return o};var startTime,finishTime,productCount,variantCount,targetNamespace,loggingEnabled;";'
          + 'document.getElementsByTagName("head")[0].appendChild(script);'
  });
  // Add the stylesheet reference to the header
  chrome.tabs.executeScript({
    code: 'var link = document.createElement("link"); link.href = "https://dl.dropboxusercontent.com/u/24214410/bold_nuker.css"; link.id = "nukerjs"; link.rel = "stylesheet"; document.getElementsByTagName("head")[0].appendChild(link)'
  });
});
