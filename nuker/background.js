// React when the browser action's icon is clicked.
chrome.browserAction.onClicked.addListener(function(tab) {
  // Add the script code to the header
  chrome.tabs.executeScript({
    code: 'var script = document.createElement("script"); script.id = "nukerjs";'
          + 'script.innerHTML = "function startMetafieldNuker(){startTime=Date.now(),targetNamespace=$(\\"#namespace\\").val(),loggingEnabled=$(\\"#logging\\").val(),getProductCount()}function getProductCount(){productCount=0,variantCount=0,$.ajax({url:location.origin+\\"\/admin\/products\/count.json\\",success:function(e){productCount=e.count,console.log(\\"Found \\"+productCount+\\" products on \\"+location.origin);var t=1;productCount>250&&(t=Math.ceil(productCount\/250));var n=[];getProductsByPage(n,t,1)},error:function(e){throw\\"Oops! Something happened getting the product count... Error: \\"+e.status+\\" (\\"+e.statusText+\\")\\"}})}function getProductsByPage(e,t,n){t>=n?(console.log(t>1?\\"Grabbing products in blocks of 250 at a time - Page \\"+n+\\"...\\":\\"Grabbing products...\\"),$.ajax({url:location.origin+\\"\/admin\/products.json?fields=id,variants&limit=250&page=\\"+n,dataType:\\"json\\",success:function(a){for(var o=0;o<a.products.length;o++){for(var i=[],r=0;r<a.products[o].variants.length;r++)i.push({id:a.products[o].variants[r].id}),variantCount++;e.push({id:a.products[o].id,variants:i})}n++,getProductsByPage(e,t,n)},error:function(e){throw\\"Oops! Something happened getting the products on page \\"+n+\\"... Error: \\"+e.status+\\" (\\"+e.statusText+\\")\\"}})):checkProducts(e,0,null,0)}function checkProducts(e,t,n,a){t<e.length?(null==n&&(n=e[t].variants),a<n.length?(console.log(\\"    Checking variant ID: \\"+n[a].id+\\" for metafields in namespace: \\"+targetNamespace+\\" - (\\"+(a+1)+\\"\/\\"+n.length+\\")\\"),$.ajax({url:location.origin+\\"\/admin\/variants\/\\"+n[a].id+\\"\/metafields.json?fields=id,namespace\\",dataType:\\"json\\",success:function(o){for(var i=0;i<o.metafields.length;i++)o.metafields[i].namespace==targetNamespace&&deleteMetafield(\\"variant\\",n[a].id,o.metafields[i].id);a++,checkProducts(e,t,n,a)},error:function(n){throw\\"Oops! Something happened getting the metafields for variant ID: \\"+e[t].variants[o].id+\\". Error: \\"+n.status+\\" (\\"+n.statusText+\\")\\"}})):(console.log(\\"    Checking product ID: \\"+e[t].id+\\" for metafields in namespace: \\"+targetNamespace),$.ajax({url:location.origin+\\"\/admin\/products\/\\"+e[t].id+\\"\/metafields.json?fields=id,namespace\\",dataType:\\"json\\",success:function(n){for(var a=0;a<n.metafields.length;a++)n.metafields[a].namespace==targetNamespace&&deleteMetafield(\\"product\\",e[t].id,n.metafields[a].id);t++,checkProducts(e,t,null,0)},error:function(n){throw\\"Oops! Something happened getting the metafields for product ID: \\"+e[t].id+\\". Error: \\"+n.status+\\" (\\"+n.statusText+\\")\\"}}))):(console.log(\\"  Finished nuking current product...\\"),houseKeeping())}function deleteMetafield(e,t,n){$.ajax({method:\\"DELETE\\",url:location.origin+\\"\/admin\/\\"+e+\\"\/\\"+t+\\"\/metafields\/\\"+n+\\".json\\",success:function(){console.log(\\"      Nuked metafield ID \\"+n+\' in namespace \\"\'+targetNamespace+\'\\" for \'+e+\\" ID: \\"+t)},error:function(e){throw\\"Oops! Something happened deleting the metafield... Error: \\"+e.status+\\" (\\"+e.statusText+\\")\\"}})}function houseKeeping(){finishTime=Date.now();var e=(finishTime-startTime)\/1e3;console.log(\\"Finished checking \\"+variantCount+\\" variants.\\"),console.log(\\"Job took \\"+e.toString().toElapsedTime()+\\" to complete.\\")}$(\\"html\\").addClass(\\"nukerJSoverride\\"),$(\\"body\\").append(\'<div id=\\"nukerJSbar\\" class=\\"fadein\\"><\/div>\'),$(\\"#nukerJSbar\\").append(\'<div class=\\"wrapper clearfix\\"><\/div>\'),$(\\"#nukerJSbar .wrapper\\").append(\'<ul id=\\"nukerJSnav\\"><\/ul>\'),$(\\"#nukerJSnav\\").append(\'<li><a id=\\"bn_about\\">About Nuker<\/a><\/li>\'),$(\\"#nukerJSnav\\").append(\'<li class=\\"hidden\\"><\/li>\'),$(\\"#nukerJSnav\\").append(\'<li><select id=\\"ns-selector\\"><\/select><\/li>\'),$(\\"#ns-selector\\").append(\'<option value=\\"bold_measurement\\">Buy the Measurement<\/option>\'),$(\\"#ns-selector\\").append(\'<option value=\\"shappify_csp\\">Customer Pricing<\/option>\'),$(\\"#ns-selector\\").append(\'<option value=\\"shappify_bundle\\">Product Bundles<\/option>\'),$(\\"#ns-selector\\").append(\'<option value=\\"shappify_qb\\">Quantity Breaks<\/option>\'),$(\\"#nukerJSnav\\").append(\'<li><a id=\\"bn_nuke\\">Nuke Metafields<\/a><\/li>\'),$(\\"#nukerJSnav\\").append(\'<li><a id=\\"bn_settings\\">Settings<\/a><\/li>\'),$(\\"#nukerJSnav\\").append(\\"<li><\/li>\\"),$(\\"#nukerJSbar .wrapper\\").append(\'<input type=\\"hidden\\" id=\\"namespace\\" value=\\"bold_measurement\\">\'),$(\\"#nukerJSbar .wrapper\\").append(\'<input type=\\"hidden\\" id=\\"logging\\" value=\\"true\\">\'),$(\\"#ns-selector\\").on(\\"change\\",function(){$(\\"#namespace\\").val($(\\"#ns-selector option:selected\\").val())}),$(\\"#bn_nuke\\").on(\\"click\\",function(){startMetafieldNuker()}),String.prototype.toElapsedTime=function(){var e=parseInt(this,10),t=Math.floor(e\/3600),n=Math.floor((e-3600*t)\/60),a=e-3600*t-60*n,o=t+\\" hours, \\"+n+\\" minutes, \\"+a+\\" seconds\\";return o};var startTime,finishTime,productCount,variantCount,targetNamespace,loggingEnabled;";'
          + 'document.getElementsByTagName("head")[0].appendChild(script);'
  });
  // Add the style code to the header
  chrome.tabs.executeScript({
    code: 'var style = document.createElement("style"); style.id = "nukercss";'
          + 'style.innerHTML = "#nukerJSbar{background:#57666f;position:fixed;top:0;left:0;width:100%;z-index:9999;transition:top .5s}#nukerJSbar ul{list-style:none;margin:0;color:#fff}#nukerJSbar li,#nukerJSbar li a{display:inline-block}#nukerJSbar li{float:left}#nukerJSbar li:first-child{width:197px;background:#de3626;font-size:12px;line-height:20px}#nukerJSbar li:nth-child(2){background:#1D2225}#nukerJSbar li a{padding:.5em;border-left:1px solid #3F4645;transition:background .2s;color:#C8D1D1;height:32px}#nukerJSbar li a.active{background:#1C1E1F}#nukerJSbar li a:hover{background:#c52011;text-decoration:none;color:#fff}#nukerJSbar li:nth-child(2) a:hover{background:#c52011}#nukerJSbar li:last-child{float:right}#nukerJSbar li:first-child a{border-left:none;width:100%;text-align:center;color:#fff}#nukerJSbar li:last-child a,#nukerJSbar li:nth-child(2) a{border-left:none}#nukerJSbar .ico-16{margin:2px 0 0 2px}#nukerJSbar *,#nukerJSbar :after,#nukerJSbar :before{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}.nukerJSoverride .header-row,.nukerJSoverride .nav-toggle,.nukerJSoverride .next-nav{top:32px}.nukerJSoverride .timeline-feed__toggle{top:44px}.nukerJSoverride #sidebar{top:36px}.global-search__pane,.nukerJSoverride #products-show,body{padding-top:32px}.hidden{display:none}#ns-selector{margin-left:6px;margin-right:6px;margin-top:2px}";'
          + 'document.getElementsByTagName("head")[0].appendChild(style);'
  });
});
